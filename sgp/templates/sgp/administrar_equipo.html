<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ proyecto.nombre }} - SGP</title>
    <style>
        .str { padding: 0 5px }
        .chk { text-align: center }
        .hidden { display: none }
    </style>
</head>
<body>
<h3>Equipo de {{ proyecto.nombre }}</h3>
<p>A continuación puede modificar los roles de los miembros del equipo del proyecto.</p>
<form action="{% url 'sgp:administrar_equipo' proyecto_id=proyecto.id %}" method="post" name="form">
{% csrf_token %}
<table>
    <tr>
        <th>Nombre</th>
        <th>Apellido</th>
        <th>E-Mail</th>
        <th>Rol</th>
    </tr>
    {{ formset.management_form }}
    {% for form in formset %}
        <tr>
            {% for field in form.hidden_fields %}
                {{ field }}
            {% endfor %}
            <td class="str">{{ form.nombre.value }}</td>
            <td class="str">{{ form.apellido.value }}</td>
            <td class="str">{{ form.email.value }}</td>
            <td class="str">{{ form.rol }}</td>
            <td class="hidden">{{ form.DELETE }}</td>
            {% if form.instance != usuario %}
                <td class="chk"><input onclick="borrar({{ forloop.counter|add:"-1" }}, this)"
                                       type="button" value="Remover"></td>
            {% else %}
                <td class="chk">Usuario actual</td>
            {% endif %}
        </tr>
    {% endfor %}
    <tr id="empty_form_row" class="hidden">
        {% for field in formset.empty_form.hidden_fields %}
            {{ field }}
        {% endfor %}
        <td class="str">{{ formset.empty_form.nombre }}</td>
        <td class="str">{{ formset.empty_form.apellido }}</td>
        <td class="str">{{ formset.empty_form.email }}</td>
        <td class="str">{{ formset.empty_form.rol }}</td>
        <td class="hidden">{{ formset.empty_form.DELETE }}</td>
        <td class="chk"><input type="button" value="Remover" onclick="borrar(__prefix__, this)"></td>
    </tr>
</table>
    <p><input type="submit" value="Guardar" name="asignar_roles"></p>
</form>

<p>Para agregar un usuario al equipo, selecciónelo de la siguiente lista.</p>
<form action="{% url 'sgp:administrar_equipo' proyecto_id=proyecto.id %}" method="post">
    {% csrf_token %}
    <table>
        <tr>
            <th>Usuario</th>
            <th>Rol</th>
        </tr>
        <tr>
            <td class="str">{{ lista.usuarios }}</td>
            <td class="str">{{ lista.roles }}</td>
        </tr>
    </table>
    <p><input type="submit" value="Agregar" name="agregar_usuario"></p>
</form>

<p><a href="{% url 'sgp:mostrar_proyecto' proyecto_id=proyecto.id %}">&#8592; Volver</a></p>

<script type="text/javascript">
    const form_idx = document.getElementById("id_form-TOTAL_FORMS")
    let total_forms = parseInt(form_idx.value);

    const table = document.querySelector('table');
    const empty_row = document.getElementById("empty_form_row");

    function agregar() {
        const clone = empty_row.cloneNode(true);
        clone.classList.remove("hidden");
        clone.innerHTML = clone.innerHTML.replace(/__prefix__/g, total_forms++);
        form_idx.value = total_forms.toString();
        table.appendChild(clone);
    }

    function borrar(form, self) {
        const del = document.getElementById("id_form-"+(form)+"-DELETE");
        const status = ! del.checked;
        del.checked = status;
        {% for field in formset.empty_form.visible_fields %}
            document.getElementById("id_form-"+(form)+"-{{ field.name }}").disabled = status;
        {% endfor %}
        del.disabled = false;
        if (status) {
            self.value = "Restaurar";
        } else {
            self.value = "Remover";
        }
    }
</script>
</body>
</html>